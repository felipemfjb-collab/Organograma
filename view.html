<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Organograma SGS</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root{
  --cream:#FAF7F2; --dark:#1A1A2E; --accent:#C8853A;
  --accent-light:#F0D5B5; --border:#E2D9CE; --border-strong:#C9B9A7;
  --text:#2C2C3E; --sub:#7A7A8C; --green:#2D6A4F; --green-light:#EAF4F0;
  --asst:#4A7FC1; --asst-light:#D6E6F7;

  --surface:#ffffff;
  --shadow: 0 4px 40px rgba(0,0,0,0.06);
}

body{
  font-family:'DM Sans',sans-serif;
  background:var(--cream);
  color:var(--text);
  min-height:100vh;
}

body.dark{
  --cream:#0f111a;
  --surface:#141827;
  --text:#E8E9F1;
  --sub:#A7A9BE;
  --border:#2b2f44;
  --border-strong:#3a3f59;
  --shadow: 0 4px 40px rgba(0,0,0,0.35);
}

header{
  background:var(--dark);
  color:white;
  padding:16px 22px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  position:sticky; top:0; z-index:100;
  box-shadow:0 2px 20px rgba(0,0,0,0.2);
}

.brand{ display:flex; align-items:center; gap:10px; }
header h1{ font-family:'DM Serif Display',serif; font-size:1.4rem; }
.badge{
  font-size:.72rem; background:var(--accent);
  padding:3px 10px; border-radius:20px;
  font-weight:800; letter-spacing:.03em;
}

.toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.toolbar-divider{ width:1px; height:32px; background:rgba(255,255,255,0.25); margin:0 4px; }

.btn{
  padding:8px 14px;
  border:none; border-radius:10px;
  font-family:'DM Sans',sans-serif;
  font-size:.83rem;
  font-weight:700;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:7px;
  transition:.2s;
  white-space:nowrap;
}
.btn:disabled{ opacity:.5; cursor:not-allowed; transform:none!important; }

.btn-accent{ background:var(--accent); color:white; }
.btn-accent:hover{ background:#a86b28; transform:translateY(-1px); }

.btn-green{ background:var(--green); color:white; }
.btn-green:hover{ background:#1e4d37; transform:translateY(-1px); }

.btn-outline{
  background:transparent;
  color:white;
  border:1.5px solid rgba(255,255,255,0.28);
}
.btn-outline:hover{ background:rgba(255,255,255,0.08); }

.btn-outline-dark{
  background:transparent;
  color:var(--text);
  border:1.5px solid var(--border-strong);
}
.btn-outline-dark:hover{
  border-color:var(--accent);
  color:var(--accent);
}

.main{ padding:30px 22px; }

.upload-section{ max-width:720px; margin:0 auto; }
.instructions{
  background:var(--surface);
  border-radius:16px;
  border:1px solid var(--border);
  padding:24px 26px;
  margin-bottom:18px;
  box-shadow:var(--shadow);
}

.instructions h3{
  font-family:'DM Serif Display',serif;
  font-size:1.2rem;
  margin-bottom:14px;
}

.step{ display:flex; gap:12px; margin-bottom:12px; align-items:flex-start; }
.step-num{
  background:var(--accent); color:white;
  border-radius:50%; width:26px; height:26px;
  display:flex; align-items:center; justify-content:center;
  font-size:.78rem; font-weight:900; flex-shrink:0; margin-top:2px;
}
.step p{ font-size:.87rem; line-height:1.55; color:var(--text); }

code{
  background:var(--accent-light);
  padding:1px 7px; border-radius:4px;
  font-size:.82rem; font-weight:900; color:var(--dark);
}

.info-box{
  background:#EEF4FF;
  border:1px solid #C0D4F0;
  border-radius:12px;
  padding:12px 14px;
  margin-top:12px;
  font-size:.85rem;
  color:#2A4A7F;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.warn-box{
  margin-top:12px;
  background:#fff3cd;
  border:1px solid #ffe69c;
  border-radius:12px;
  padding:12px 14px;
  color:#7a5a00;
  font-size:.86rem;
}
.warn-box ul{ margin-top:8px; padding-left:18px; }
.warn-box li{ margin:4px 0; }

.download-tpl{
  display:inline-flex; align-items:center; gap:6px;
  color:var(--accent); font-weight:800; font-size:.85rem;
  cursor:pointer; border:none; background:none; padding:0;
  margin-top:12px; text-decoration:underline; text-underline-offset:3px;
}

.upload-zone{
  border:2.5px dashed var(--border);
  border-radius:20px;
  background:var(--surface);
  padding:46px 30px;
  text-align:center;
  cursor:pointer;
  transition:.3s;
  box-shadow:var(--shadow);
}
.upload-zone:hover,.upload-zone.drag{ border-color:var(--accent); background:#FDF5EA; }
.upload-zone h2{
  font-family:'DM Serif Display',serif;
  font-size:1.5rem;
  margin-bottom:8px;
}
.upload-zone p{ color:var(--sub); font-size:.88rem; }
#fileInput{ display:none; }

/* CHART */
.status-bar{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
.stat{
  background:var(--surface); border:1px solid var(--border);
  border-radius:10px; padding:9px 14px; font-size:.84rem;
  box-shadow:var(--shadow);
}
.stat strong{ color:var(--accent); font-size:1.1rem; margin-right:4px; }
.tip{
  background:var(--green-light); border:1px solid #C3E0D4;
  border-radius:10px; padding:9px 14px; font-size:.82rem;
  color:var(--green); margin-left:auto;
}

/* FILTERS */
.filters-bar{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px 16px;
  margin-bottom:12px;
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
  box-shadow:var(--shadow);
}
.filter-group{ display:flex; flex-direction:column; gap:4px; min-width:160px; }
.filter-label{ font-size:.72rem; font-weight:900; color:var(--sub); text-transform:uppercase; letter-spacing:.05em; }
.filter-input{
  padding:6px 10px; border:1.5px solid var(--border);
  border-radius:10px; font-family:'DM Sans',sans-serif;
  font-size:.84rem; color:var(--text);
  background:var(--cream); outline:none;
}
.filter-input:focus{ border-color:var(--accent); }
.filter-divider{ width:1px; height:40px; background:var(--border); margin:0 2px; }
.filter-btn{
  padding:6px 14px; border:1.5px solid var(--border);
  border-radius:10px; font-family:'DM Sans',sans-serif;
  font-size:.82rem; font-weight:800;
  cursor:pointer; background:var(--surface); color:var(--sub);
  transition:.2s; white-space:nowrap;
}
.filter-btn:hover{ border-color:var(--accent); color:var(--accent); }
.search-wrap{ position:relative; }
.search-wrap svg{ position:absolute; left:9px; top:50%; transform:translateY(-50%); color:var(--sub); pointer-events:none; }
.search-wrap .filter-input{ padding-left:30px; }

/* Legend + chart */
.legend{ display:flex; gap:18px; align-items:center; margin-bottom:10px; font-size:.8rem; color:var(--sub); flex-wrap:wrap; }
.legend-item{ display:flex; align-items:center; gap:7px; }
.leg-box{ width:22px; height:14px; border-radius:4px; }

.chart-wrap{
  background:var(--surface);
  border-radius:16px;
  border:1px solid var(--border);
  padding:26px 18px;
  overflow:auto;
  box-shadow:var(--shadow);
  cursor:grab;
  user-select:none;
  height: calc(100vh - 320px);
  min-height: 420px;
}
.chart-wrap.dragging{ cursor:grabbing; }

#orgChart{
  display:inline-flex;
  flex-direction:column;
  align-items:center;
  min-width:100%;
  transform-origin: top left;
}

/* Nodes */
.node{
  background:rgba(255,255,255,0.98);
  border:2px solid var(--border-strong);
  border-radius:12px;
  padding:10px 16px;
  min-width:150px;
  max-width:230px;
  text-align:center;
  box-shadow:0 2px 12px rgba(0,0,0,0.07);
  transition:box-shadow .2s, transform .2s;
  position:relative;
}
body.dark .node{ background:rgba(20,24,39,0.95); }

.node:hover{ box-shadow:0 8px 26px rgba(200,133,58,0.22); transform:translateY(-2px); }

.node-name{ font-weight:800; font-size:.87rem; color:var(--text); line-height:1.25; margin-bottom:6px; }
.node-role{
  font-size:.69rem; font-weight:900;
  background:var(--accent-light); color:var(--accent);
  border-radius:6px; padding:3px 10px;
  display:inline-block;
  text-transform:uppercase;
  letter-spacing:.05em;
}
.node.root{ border:2px solid var(--accent); }
.node.root .node-role{ background:var(--accent); color:white; }

.node.assistant{ border:2px dashed var(--asst); }
.node.assistant .node-role{ background:var(--asst-light); color:var(--asst); }

.v-line{ width:2px; background:var(--accent); margin:0 auto; }

/* Collapse btn */
.node .collapse-btn{
  position:absolute; bottom:-10px; left:50%; transform:translateX(-50%);
  width:18px; height:18px; border-radius:50%;
  background:var(--accent); color:white; border:none;
  font-size:.7rem; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-weight:900; z-index:10; line-height:1;
  box-shadow:0 1px 4px rgba(0,0,0,0.25);
}

/* Search highlight */
.node.highlighted{ border:2px solid #F5A623!important; box-shadow:0 0 0 3px rgba(245,166,35,0.3)!important; }
.node.dimmed{ opacity:.22; }

/* ASSISTENTES: √† direita do gestor, na mesma linha horizontal */
.assistants-below{
  display:flex;
  flex-direction:row;
  align-items:center;
  gap:0;
}

/* Team box */
.team-box{
  border-radius:12px; overflow:hidden;
  min-width:180px; max-width:260px;
  box-shadow:0 4px 16px rgba(0,0,0,0.13);
}
.team-box-header{
  background:#1e4d37;
  color:white;
  padding:7px 12px;
  font-size:.72rem;
  font-weight:900;
  text-transform:uppercase;
  letter-spacing:.07em;
  text-align:center;
}
.team-box-body{ background:var(--green); padding:10px 12px; }
.team-box-member{
  display:flex; align-items:center; gap:8px;
  color:white; font-size:.79rem;
  padding:5px 0;
  border-bottom:1px solid rgba(255,255,255,0.16);
}
.team-box-member:last-child{ border-bottom:none; }
.team-box-member .num{ font-size:.68rem; opacity:.65; min-width:16px; font-weight:900; }

/* Zoom UI */
.zoom-box{ display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.2); }
.zoom-pill{ font-weight:900; font-size:.78rem; color:#fff; opacity:.95; min-width:44px; text-align:right; }
.zoom-range{ width:140px; }

.node.flash{ box-shadow:0 0 0 4px rgba(200,133,58,0.25); }
</style>
<script src="data.js"></script>
</head>
<body>

<header>
  <div class="brand">
    <span style="font-size:1.3rem;font-weight:900;color:#C8853A;letter-spacing:-.02em">SGS</span>
    <div class="toolbar-divider"></div>
    <h1>Organograma</h1>
    <span class="badge" style="background:#4A7FC1">VISUALIZA√á√ÉO</span>
  </div>
  <div class="toolbar">
    <button class="btn btn-outline" id="darkBtn" onclick="toggleDark()">üåô Modo escuro</button>
    <div class="zoom-box">
      <span class="zoom-pill" id="zoomPill">100%</span>
      <input id="zoomRange" class="zoom-range" type="range" min="10" max="150" value="100"
             oninput="applyZoom(this.value)">
    </div>
  </div>
</header>

<div class="main">
  <div class="status-bar" id="statusBar">
    <div class="stat" style="color:var(--sub)">‚è≥ Carregando organograma...</div>
  </div>

  <div class="filters-bar" id="filtersBar" style="display:none">
    <div class="filter-group" style="min-width:220px">
      <div class="filter-label">üîç Buscar pessoa</div>
      <div class="search-wrap">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
        </svg>
        <input class="filter-input" id="searchInput" type="text" placeholder="Nome..." oninput="applySearch()">
      </div>
    </div>
    <div class="filter-divider"></div>
    <div class="filter-group">
      <div class="filter-label">üè¢ Filtrar por √°rea</div>
      <select class="filter-input" id="areaSelect" onchange="applyAreaFilter()">
        <option value="">Todas as √°reas</option>
      </select>
    </div>
    <div class="filter-divider"></div>
    <div class="filter-group">
      <div class="filter-label">üìä Mostrar at√© n√≠vel</div>
      <select class="filter-input" id="levelSelect" onchange="applyLevelFilter()">
        <option value="99">Todos os n√≠veis</option>
      </select>
    </div>
    <div class="filter-divider"></div>
    <div class="filter-group" style="min-width:auto">
      <div class="filter-label">üìÇ Recolher</div>
      <div style="display:flex;gap:6px">
        <button class="filter-btn" onclick="expandAll()">Expandir tudo</button>
        <button class="filter-btn" onclick="collapseAll()">Recolher tudo</button>
      </div>
    </div>
    <button class="filter-btn" onclick="resetFilters()" style="align-self:flex-end;margin-left:auto">‚úï Limpar filtros</button>
  </div>

  <div class="legend" id="legendBar" style="display:none">
    <span class="legend-item"><span class="leg-box" style="border:2px solid var(--border-strong);background:white"></span> Hierarquia normal</span>
    <span class="legend-item"><span class="leg-box" style="border:2px dashed var(--asst);background:var(--asst-light)"></span> Assistente</span>
    <span class="legend-item"><span class="leg-box" style="background:var(--green);border-radius:3px"></span> Equipe</span>
    <span class="legend-item" style="color:var(--sub);font-size:.78rem">üñ±Ô∏è Arraste para navegar ‚Ä¢ Scroll para zoom</span>
  </div>

  <div class="chart-wrap" id="chartWrap" style="display:none">
    <div id="orgChart"></div>
  </div>

  <div id="errorMsg" style="display:none;padding:40px;text-align:center;color:#c0392b;font-size:1rem;">
    ‚ö†Ô∏è N√£o foi poss√≠vel carregar os dados.<br>
    <small style="color:var(--sub)">Verifique se o arquivo data.json est√° na mesma pasta.</small>
  </div>
</div>

<script>
var orgData = [];
var currentRoots = [], maxDepth = 0, countsMap = {};


function clamp(v,a,b){ return Math.min(b, Math.max(a,v)); }


function normStr(s){ return String(s||"").trim(); }


function stripAccents(s){ var r="",str=String(s||"").normalize("NFD"); for(var i=0;i<str.length;i++){ var c=str.charCodeAt(i); if(c<768||c>879) r+=str[i]; } return r; }
}


function computeCounts(roots){
  const m={};
  function walk(n){
    const direct=(n.children?.length||0);
    let total=direct;
    (n.children||[]).forEach(ch=> total += 1 + walk(ch));
    m[n.id]={direct,total};
    return total;
  }
  roots.forEach(r=>walk(r));
  return m;
}


function calcMaxDepth(node,d){
  maxDepth=Math.max(maxDepth,d);
  (node.children||[]).forEach(c=>calcMaxDepth(c,d+1));
}


function childrenAreLeaves(node){
  return (node.children||[]).every(c => (c.children||[]).length===0);
}


function groupLeafChildrenByEquipe(children){
  const map = new Map();
  (children||[]).forEach(ch=>{
    const key = (ch.equipe && String(ch.equipe).trim()) ? String(ch.equipe).trim() : "EQUIPE";
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(ch);
  });

  const groups = Array.from(map.entries()).map(([teamName, items])=>{
    items.sort((a,b)=> (a.nome||"").localeCompare(b.nome||"", "pt-BR"));
    return { teamName, items };
  });

  groups.sort((a,b)=>{
    if(a.teamName==="EQUIPE" && b.teamName!=="EQUIPE") return 1;
    if(b.teamName==="EQUIPE" && a.teamName!=="EQUIPE") return -1;
    return a.teamName.localeCompare(b.teamName, "pt-BR");
  });

  return groups;
}


function makeTeamBox(children, teamName){
  const box=document.createElement("div");
  box.className="team-box";

  const header=document.createElement("div");
  header.className="team-box-header";
  header.textContent = (teamName && String(teamName).trim()) ? String(teamName).trim() : "EQUIPE";
  box.appendChild(header);

  const body=document.createElement("div");
  body.className="team-box-body";

  children.forEach((child,i)=>{
    const member=document.createElement("div");
    member.className="team-box-member";

    // fun√ß√£o abaixo do nome
    member.innerHTML = `
      <span class="num">${i+1}</span>
      <div class="team-member-text" style="display:flex;flex-direction:column;gap:2px;">
        <div class="team-member-name" style="font-weight:700;line-height:1.1;">${child.nome || ""}</div>
        ${child.cargo ? `<div class="team-member-role" style="opacity:.75;font-size:.72rem;line-height:1.1;">${child.cargo}</div>` : ""}
      </div>
    `;
    body.appendChild(member);
  });

  box.appendChild(body);
  return box;
}


function renderSubtree(node, depth, parentNode){
  const wrap=document.createElement("div");
  wrap.style.cssText="display:flex;flex-direction:column;align-items:center;";

  const hasAssistants = node.assistants && node.assistants.length>0;
  const hasChildren   = node.children && node.children.length>0;

  let childrenEl=null, vDown=null, assistantsEl=null;

  const counts = countsMap[node.id] || {direct:0,total:0};
  const tip = [
    `Reporta para: ${parentNode ? parentNode.nome : "Topo"}`,
    `Subordinados: ${counts.direct} diretos / ${counts.total} total`,
    `ID: ${node.id}`
  ].join("\n");

  const card=document.createElement("div");
  card.className="node" + (depth===0 ? " root" : "");
  card.title = tip;
  card.innerHTML = `<div class="node-name">${node.nome}</div><div class="node-role">${node.cargo||"‚Äî"}</div>`;

  card.addEventListener("click",(e)=>{
    e.stopPropagation();
    card.scrollIntoView({behavior:"smooth", block:"center", inline:"center"});
    card.classList.add("flash");
    setTimeout(()=>card.classList.remove("flash"),420);
  });

  if(hasChildren || hasAssistants){
    const btn=document.createElement("button");
    btn.className="collapse-btn";
    btn.textContent="‚àí";
    btn.title="Recolher/Expandir";
    btn.addEventListener("click",(e)=>{
      e.stopPropagation();
      const anyVisible =
        (childrenEl && childrenEl.style.display!=="none") ||
        (vDown && vDown.style.display!=="none") ||
        (assistantsEl && assistantsEl.style.display!=="none");

      const val = anyVisible ? "none" : "";
      if(assistantsEl) assistantsEl.style.display = val;
      if(childrenEl) childrenEl.style.display = val;
      if(vDown) vDown.style.display = val;

      btn.textContent = anyVisible ? "+" : "‚àí";
    });
    card.appendChild(btn);
  }

  // Card centered in wrap
  wrap.appendChild(card);

  // Assistants BELOW the card, connected by the vertical spine
  // Each row: [aCard] [dash 28px] [vSeg 2px]  ‚Äî centered under card
  // The vSeg (rightmost 2px) must align with the card's center axis.
  // We achieve this by centering each aRow in wrap and making vSeg flush-right
  // of the card+dash combination, using a hidden mirror on the right.
  if(hasAssistants){
    assistantsEl = document.createElement("div");
    assistantsEl.className = "assistants-below";
    assistantsEl.style.cssText = "display:flex;flex-direction:column;align-items:center;width:100%;";

    node.assistants.forEach(asst => {
      // aRow: [aCard][dash][vSeg]  all in one flex-row
      // We use a trick: aRow is centered in wrap (align-items:center on wrap)
      // aCard is on the LEFT, vSeg is the 2px RIGHT edge aligned with card center
      // Mirror (hidden) on right keeps centering stable
      const aRow = document.createElement("div");
      aRow.style.cssText = "display:flex;flex-direction:row;align-items:center;";

      const aCard = document.createElement("div");
      aCard.className = "node assistant";
      aCard.title = `Reporta para: ${node.nome}\nID: ${asst.id}`;
      aCard.innerHTML = `<div class="node-name">${asst.nome}</div><div class="node-role">${asst.cargo||"‚Äî"}</div>`;
      aCard.addEventListener("click",(e)=>{
        e.stopPropagation();
        aCard.scrollIntoView({behavior:"smooth", block:"center", inline:"center"});
        aCard.classList.add("flash");
        setTimeout(()=>aCard.classList.remove("flash"),420);
      });

      const dash = document.createElement("div");
      dash.style.cssText = "width:28px;border-top:2px dashed var(--asst);flex-shrink:0;";

      // vSeg: continues the vertical spine through the assistant row
      const vSeg = document.createElement("div");
      vSeg.style.cssText = "width:2px;align-self:stretch;min-height:50px;background:var(--accent);flex-shrink:0;";

      // Mirror: invisible clone to balance the row so vSeg stays centered
      const mirror = document.createElement("div");
      mirror.style.cssText = "visibility:hidden;display:flex;flex-direction:row;align-items:center;pointer-events:none;";
      const mDash = document.createElement("div");
      mDash.style.cssText = "width:28px;flex-shrink:0;";
      const mCard = aCard.cloneNode(true);
      mCard.style.cssText = (mCard.style.cssText||"") + ";visibility:hidden;";
      mirror.appendChild(mDash);
      mirror.appendChild(mCard);

      aRow.appendChild(aCard);
      aRow.appendChild(dash);
      aRow.appendChild(vSeg);
      aRow.appendChild(mirror);

      assistantsEl.appendChild(aRow);
    });

    wrap.appendChild(assistantsEl);
  }

  // filhos
  if(hasChildren){
    vDown=document.createElement("div");
    vDown.className="v-line";
    vDown.style.height="28px";
    vDown.style.marginTop = hasAssistants ? "14px" : "10px";
    wrap.appendChild(vDown);

    childrenEl=document.createElement("div");
    childrenEl.className="subtree-children";
    childrenEl.setAttribute("data-depth", depth+1);
    childrenEl._vline=vDown;

    // √öLTIMO N√çVEL: agrupa por Equipe
    if(childrenAreLeaves(node)){
      const groups = groupLeafChildrenByEquipe(node.children);

      if (groups.length <= 1) {
        childrenEl.style.cssText = "display:flex;flex-direction:column;align-items:center;gap:14px;";
      } else {
        // ‚úÖ TUDO lado a lado, sem quebrar linha
        childrenEl.style.cssText =
          "display:flex;flex-direction:row;flex-wrap:nowrap;justify-content:flex-start;align-items:flex-start;gap:18px;";
      }

      // ‚úÖ largura m√≠nima para TODAS as caixas caberem na mesma linha
      if (groups.length > 1) {
        const BOX_W = 240;     // ~team-box (max 220) + folga
        const GAP   = 18;      // mesmo gap do flex
        const minW  = groups.length * BOX_W + (groups.length - 1) * GAP;

        childrenEl.style.minWidth = minW + "px";
        wrap.style.minWidth = Math.max(minW, 260) + "px";
      }

      groups.forEach(g=>{
        childrenEl.appendChild(makeTeamBox(g.items, g.teamName));
      });

    } else if(node.children.length===1){
      childrenEl.style.cssText="display:flex;flex-direction:column;align-items:center;";
      childrenEl.appendChild(renderSubtree(node.children[0], depth+1, node));

    } else {
      childrenEl.style.cssText="display:flex;flex-direction:column;align-items:center;";
      const cols=document.createElement("div");
      cols.style.cssText="display:flex;align-items:flex-start;";

      node.children.forEach((child,i)=>{
        const isFirst = i===0;
        const isLast  = i===node.children.length-1;

        const col=document.createElement("div");
        col.style.cssText="display:flex;flex-direction:column;align-items:center;padding:0 18px;position:relative;";

        const hSeg=document.createElement("div");
        hSeg.style.cssText=`position:absolute;top:0;height:2px;background:var(--accent);left:${isFirst?"50%":"0"};right:${isLast?"50%":"0"};`;
        col.appendChild(hSeg);

        const vTop=document.createElement("div");
        vTop.className="v-line";
        vTop.style.height="24px";
        col.appendChild(vTop);

        col.appendChild(renderSubtree(child, depth+1, node));
        cols.appendChild(col);
      });

      childrenEl.appendChild(cols);
    }

    wrap.appendChild(childrenEl);
  }

  return wrap;
}


function drawChart(roots){
  const chart=document.getElementById("orgChart");
  chart.innerHTML="";

  if(!roots.length){
    chart.innerHTML='<p style="color:red;padding:20px">Nenhuma raiz encontrada.</p>';
    return;
  }

  if(roots.length===1){
    chart.appendChild(renderSubtree(roots[0],0,null));
  }else{
    const row=document.createElement("div");
    row.style.cssText="display:flex;gap:60px;align-items:flex-start;justify-content:center;";
    roots.forEach(r=>row.appendChild(renderSubtree(r,0,null)));
    chart.appendChild(row);
  }
}


function applySearch(){
  const inp = document.getElementById("searchInput");
  if(!inp) return;
  const q = inp.value.trim().toLowerCase();

  const areaSel = document.getElementById("areaSelect");
  const levelSel = document.getElementById("levelSelect");
  if(areaSel) areaSel.value="";
  if(levelSel) levelSel.value="99";

  document.querySelectorAll(".node").forEach(el=>{
    el.classList.remove("highlighted","dimmed");
  });
  if(!q) return;

  document.querySelectorAll(".node").forEach(el=>{
    const name = (el.querySelector(".node-name")||{}).textContent||"";
    if(name.toLowerCase().includes(q)) el.classList.add("highlighted");
    else el.classList.add("dimmed");
  });
  document.querySelectorAll(".node.highlighted").forEach(el=> el.classList.remove("dimmed"));
}


function applyAreaFilter(){
  const areaSel = document.getElementById("areaSelect");
  if(!areaSel) return;
  const areaId=areaSel.value;

  const search = document.getElementById("searchInput");
  const levelSel = document.getElementById("levelSelect");
  if(search) search.value="";
  if(levelSel) levelSel.value="99";

  document.querySelectorAll(".node").forEach(el=> el.classList.remove("highlighted","dimmed"));

  if(!areaId){ drawChart(currentRoots); return; }

  function findById(nodes,id){
    for(const n of nodes){
      if(n.id===id) return n;
      const f=findById(n.children,id);
      if(f) return f;
    }
    return null;
  }

  if(currentRoots.length===1){
    const areaNode=findById(currentRoots[0].children, areaId);
    if(areaNode){
      const fakeRoot={...currentRoots[0], children:[areaNode], assistants: currentRoots[0].assistants};
      drawChart([fakeRoot]);
      return;
    }
  }
  const n=findById(currentRoots, areaId);
  if(n) drawChart([n]);
}


function applyLevelFilter(){
  const levelSel = document.getElementById("levelSelect");
  if(!levelSel) return;
  const maxLvl=parseInt(levelSel.value,10);

  const search = document.getElementById("searchInput");
  const areaSel = document.getElementById("areaSelect");
  if(search) search.value="";
  if(areaSel) areaSel.value="";

  document.querySelectorAll(".node").forEach(el=> el.classList.remove("highlighted","dimmed"));

  document.querySelectorAll(".subtree-children").forEach(el=>{
    el.style.display="";
    if(el._vline) el._vline.style.display="";
  });
  document.querySelectorAll(".assistants-below").forEach(el=> el.style.display="");
  document.querySelectorAll(".node .collapse-btn").forEach(btn=> btn.textContent="‚àí");

  document.querySelectorAll('.subtree-children[data-depth]').forEach(el=>{
    const d=parseInt(el.getAttribute("data-depth"),10);
    if(d>maxLvl){
      el.style.display="none";
      if(el._vline) el._vline.style.display="none";
      const parent=el.parentElement;
      if(parent){
        const btn=parent.querySelector(':scope .collapse-btn');
        if(btn) btn.textContent="+";
      }
    }
  });
}


function expandAll(){
  document.querySelectorAll(".subtree-children").forEach(el=>{
    el.style.display="";
    if(el._vline) el._vline.style.display="";
  });
  document.querySelectorAll(".assistants-below").forEach(el=> el.style.display="");
  document.querySelectorAll(".node .collapse-btn").forEach(btn=> btn.textContent="‚àí");
}


function collapseAll(){
  document.querySelectorAll(".subtree-children").forEach(el=>{
    el.style.display="none";
    if(el._vline) el._vline.style.display="none";
  });
  document.querySelectorAll(".assistants-below").forEach(el=> el.style.display="none");
  document.querySelectorAll(".node .collapse-btn").forEach(btn=> btn.textContent="+");
}


function resetFilters(){
  const search = document.getElementById("searchInput");
  const areaSel = document.getElementById("areaSelect");
  const levelSel = document.getElementById("levelSelect");
  if(search) search.value="";
  if(areaSel) areaSel.value="";
  if(levelSel) levelSel.value="99";

  document.querySelectorAll(".node").forEach(el=> el.classList.remove("highlighted","dimmed"));
  expandAll();
  drawChart(currentRoots);
}

function toggleDark() {
  document.body.classList.toggle("dark");
  var b = document.getElementById("darkBtn");
  if(b) b.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Modo claro" : "üåô Modo escuro";
}

function applyZoom(v) {
  v = Math.min(150, Math.max(10, parseInt(v, 10)));
  var pl = document.getElementById("zoomPill"); if(pl) pl.textContent = v + "%";
  var o  = document.getElementById("orgChart"); if(o)  o.style.transform = "scale(" + v/100 + ")";
}

// Pan
(function(){
  var wrap = document.getElementById("chartWrap"); if(!wrap) return;
  var isDown=false, sx=0, sy=0, sl=0, st=0, dd=0, drag=false;
  wrap.addEventListener("mousedown", function(e){
    if(e.button!==0||e.target.closest("button")||e.target.closest("input")||e.target.closest("select")) return;
    isDown=true; drag=false; dd=0; wrap.classList.add("dragging");
    sx=e.clientX; sy=e.clientY; sl=wrap.scrollLeft; st=wrap.scrollTop;
  });
  window.addEventListener("mousemove", function(e){
    if(!isDown) return;
    var dx=e.clientX-sx, dy=e.clientY-sy;
    dd=Math.max(dd,Math.abs(dx)+Math.abs(dy)); if(dd>3) drag=true;
    wrap.scrollLeft=sl-dx; wrap.scrollTop=st-dy;
  });
  window.addEventListener("mouseup", function(){ isDown=false; wrap.classList.remove("dragging"); });
  wrap.addEventListener("click", function(e){ if(drag){ e.preventDefault(); e.stopPropagation(); drag=false; } }, true);
  wrap.addEventListener("wheel", function(e){
    e.preventDefault();
    var r=document.getElementById("zoomRange"); if(!r) return;
    var z=Math.min(150,Math.max(10,parseInt(r.value||"100",10)+(e.deltaY<0?5:-5)));
    r.value=z; applyZoom(z);
  }, {passive:false});
})();

function initChart(data) {
  orgData = data;
  currentRoots = buildTree(orgData);
  maxDepth = 0; currentRoots.forEach(function(r){ calcMaxDepth(r, 0); });
  countsMap = computeCounts(currentRoots);

  // Status bar
  var ac = orgData.filter(function(p){ return p.assistente; }).length;
  var sb = document.getElementById("statusBar");
  if(sb) {
    sb.innerHTML = "";
    var d1=document.createElement("div"); d1.className="stat";
    var s1=document.createElement("strong"); s1.textContent=orgData.length;
    d1.appendChild(s1); d1.appendChild(document.createTextNode(" pessoas"));
    var d2=document.createElement("div"); d2.className="stat";
    var s2=document.createElement("strong"); s2.textContent=(orgData.length-ac);
    d2.appendChild(s2); d2.appendChild(document.createTextNode(" na hierarquia"));
    var d3=document.createElement("div"); d3.className="tip";
    d3.textContent = "üëÅÔ∏è Modo visualiza√ß√£o";
    sb.appendChild(d1); sb.appendChild(d2); sb.appendChild(d3);
  }

  // Level select
  var ls = document.getElementById("levelSelect");
  if(ls){ for(var i=1;i<=maxDepth;i++){var o=document.createElement("option");o.value=i;o.textContent="At√© n√≠vel "+i;ls.appendChild(o);} }

  // Area select
  var asel = document.getElementById("areaSelect");
  if(asel){
    var ns = (currentRoots.length===1&&currentRoots[0].children.length>0) ? currentRoots[0].children : currentRoots;
    ns.forEach(function(n){ var o=document.createElement("option");o.value=n.id;o.textContent=n.nome+" ("+(n.cargo||"-")+")";asel.appendChild(o); });
  }

  // Show UI
  document.getElementById("filtersBar").style.display = "";
  document.getElementById("legendBar").style.display  = "";
  document.getElementById("chartWrap").style.display  = "";

  drawChart(currentRoots);
}

// Try all possible variable names from data.js
window.addEventListener("load", function() {
  var data = null;
  if (typeof window.ORG_DATA !== "undefined" && window.ORG_DATA && window.ORG_DATA.length) {
    data = window.ORG_DATA;
  } else if (typeof window.orgData !== "undefined" && window.orgData && window.orgData.length) {
    data = window.orgData;
  }
  
  if (data && data.length) {
    initChart(data);
  } else {
    console.error("No data found. Make sure data.js is uploaded to GitHub.");
    document.getElementById("statusBar").innerHTML = 
      '<div style="color:#c0392b;padding:10px">‚ö†Ô∏è Dados n√£o encontrados. Verifique se o data.js foi enviado ao GitHub.</div>';
  }
});
</script>
</body>
</html>